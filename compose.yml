services:
  asb-backend:
    depends_on:
      sqledge:
        condition: service_healthy
    pull_policy: always
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    ports:
      - "5672:5672"
      - "5300:5300"
    volumes:
      - ./compose/asb.json:/ServiceBus_Emulator/ConfigFiles/Config.json
    environment:
      SQL_WAIT_INTERVAL: 0
      SQL_SERVER: sqledge
      MSSQL_SA_PASSWORD: "s4usag3s!"
      ACCEPT_EULA: "Y"
    profiles:
      - paycal
      - packaging
      - synapse

  asb:
    depends_on:
      asb-backend:
        condition: service_started
    pull_policy: always
    image: alpine/curl:latest
    command: ["tail", "-f", "/dev/null"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://asb-backend:5300/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal
      - packaging
      - synapse

  sqledge:
    pull_policy: always
    image: mcr.microsoft.com/azure-sql-edge:latest
    # On some platforms there are compatibility issues with running Azure SQL Edge e.g. M1 Macs with later Docker versions.
    # If SQL Edge does not work for you, try swapping out with SQL Server image instead
    # image: mcr.microsoft.com/mssql/server:2022-latest
    ports:
      - "1433:1433"
    volumes:
      - sqledge-data:/var/opt/mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "s4usag3s!"
    healthcheck:
      interval: 5s
      retries: 10
      start_period: 5s
      test: timeout 1 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/1433'
      timeout: 5s
    profiles:
      - paycal
      - packaging
      - prn
      - synapse

  azurite:
    pull_policy: always
    image: mcr.microsoft.com/azure-storage/azurite:latest
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    command: "azurite --skipApiVersionCheck --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --location /data"
    healthcheck:
      test: [ "CMD-SHELL", "nc -z 127.0.0.1 10000" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal
      - packaging
      - synapse

  azurite-init:
    pull_policy: always
    image: mcr.microsoft.com/azure-cli:latest
    depends_on:
      azurite:
        condition: service_healthy
    entrypoint: >
      sh -c "
      az storage container create --name 'paycal' --connection-string 'DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;' &&
      az storage container create --name 'paycal-billingfilecsv' --connection-string 'DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;' &&
      az storage container create --name 'paycal-billingfilejson' --connection-string 'DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;' &&
      az storage container create --name 'paycal-billingfilejsonauthorisedforfss' --connection-string 'DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;' &&
      echo 'containers created successfully'
      "
    profiles:
      - paycal
      - packaging

  token-provider:
    image: mcr.microsoft.com/azure-cli
    volumes:
      - ~/.azure:/root/.azure
      - token-cache:/tokens
    command: >
      sh -c "az account get-access-token --resource https://sql.azuresynapse.net --query accessToken -o tsv > /tokens/sql.azuresynapse_token.txt &&
      echo 'Token retrieved' &&
      while true; do
        sleep 3000;
        az account get-access-token --resource https://sql.azuresynapse.net --query accessToken -o tsv > /tokens/sql.azuresynapse_token.txt;
        echo 'Token refreshed at' $$(date);
      done"
    healthcheck:
      test: [ "CMD", "test", "-f", "/tokens/sql.azuresynapse_token.txt" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    profiles:
      - prn

  redis:
    pull_policy: always
    image: redis/redis-stack:latest
    ports:
      - "6379:6379"
      - "8005:8001" # use http://localhost:8005/redis-stack/browser to view active keys
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - packaging

  wiremock:
    pull_policy: always
    environment:
      TZ: Europe/London
    image: sheyenrath/wiremock.net:latest
    ports:
      - "9090:80"
    profiles:
      - paycal
      - packaging
      - synapse

  epr-calculator-service:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcalculatorservicerepository:${EPR_CALCULATOR_SERVICE:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
      asb:
        condition: service_healthy
      epr-calculator-api:
        condition: service_healthy
      azurite:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ServiceBusConnectionString: Endpoint=sb://asb-backend;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;
      ServiceBusQueueName: defra.epr.calculator.run.local
      PipelineUrl: http://wiremock
      GetOrgDataPipelineName: pip_paycal_get_org_data
      GetPomDataPipelineName: pip_paycal_get_pom_data
      MaxCheckCount: 10
      CheckInterval: 5
      FUNCTIONS_WORKER_RUNTIME: dotnet
      FUNCTIONS_INPROC_NET8_ENABLED: 1
      Execute_RPD_Pipeline: false
      DbConnectionString: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=PayCal;TrustServerCertificate=True"
      BlobConnectionString: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;"
      StatusUpdateEndpoint: http://epr-calculator-api:8080/v1/internal/rpdStatus
      PrepareCalcResultEndPoint: http://epr-calculator-api:8080/v1/internal/prepareCalcResults
      # https://github.com/dotnet/runtime/issues/103063
      DOTNET_EnableWriteXorExecute: 0
      APPINSIGHTS_INSTRUMENTATIONKEY: 00000000-0000-0000-0000-000000000000
      ResultFileCSVContainerName: "paycal"
      BillingFileCSVBlobContainerName: "paycal-billingfilecsv"
      BillingFileJsonBlobContainerName: "paycal-billingfilejson"
    ports:
      - "8001:80"
    healthcheck:
      test: [ "CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/80' || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal

  epr-calculator-api:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcalculatorapirepository:${EPR_CALCULATOR_API:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
      asb:
        condition: service_healthy
      azurite:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      AzureAd__TenantId: 6f504113-6b64-43f2-ade9-242e05780007
      AzureAd__ClientId: 28b6c996-1817-4e2b-b04d-8578064d5283
      ServiceBus__ConnectionString: Endpoint=sb://asb-backend;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;
      ServiceBus__QueueName: defra.epr.calculator.run.local
      ConnectionStrings__DefaultConnection: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=PayCal;TrustServerCertificate=True"
      BlobStorage__ConnectionString: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;"
      BlobStorage__ResultFileCSVContainerName: "paycal"
      BlobStorage__BillingFileCSVContainerName: "paycal-billingfilecsv"
      BlobStorage__BillingFileJsonContainerName: "paycal-billingfilejson"
      BlobStorage__BillingFileJsonForFssContainerName: "paycal-billingfilejsonauthorisedforfss"
    ports:
      - "5055:8080"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal

  epr-calculator-api-migrations:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcalculatorapirepository:${EPR_CALCULATOR_API_MIGRATIONS:-main-latest-database-migrations}
    command: [ "/bin/bash", "/home/nonroot/sql/run-migrations.sh", "/home/nonroot/sql/migrations.sql", "/home/nonroot/sql/seed.sql" ]
    depends_on:
      sqledge:
        condition: service_healthy
    volumes:
      - ./compose/migrations/run-migrations.sh:/home/nonroot/sql/run-migrations.sh
      - ./compose/epr-calculator-api-migrations/seed.sql:/home/nonroot/sql/seed.sql
    environment:
      SERVER: sqledge
      PORT: 1433
      USER: sa
      PASSWORD: "s4usag3s!"
      DATABASE: PayCal
    profiles:
      - paycal

  epr-calculator-frontend:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcalculatorfrontendrepository:${EPR_CALCULATOR_FRONTEND:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
      asb:
        condition: service_healthy
      epr-calculator-api:
        condition: service_healthy
      azurite:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      AzureAd__TenantId: 6f504113-6b64-43f2-ade9-242e05780007
      AzureAd__ClientId: f94d57e6-b554-4cb6-b26b-fc3fb838eaa0
      AzureAd__ClientSecret: ${EprCalculatorFrontend__AzureAd__ClientSecret} # see .env
      DownstreamApi__Scopes: api://28b6c996-1817-4e2b-b04d-8578064d5283/default
      FinancialYearListApi: http://epr-calculator-api:8080/v1/financialYears
      DashboardCalculatorRun__DashboardCalculatorRunApi: http://epr-calculator-api:8080/v1/calculatorRuns
      DashboardCalculatorRun__DashboardCalculatorRunApiV2: http://epr-calculator-api:8080/v2/calculatorRuns
      CalculationRunSettings__CalculationRunNameApi: http://epr-calculator-api:8080/v1/CheckCalcNameExists
      CalculationRunSettings__CalculationRunApi: http://epr-calculator-api:8080/v1/calculatorRun
      CalculationRunSettings__DownloadResultApi: http://epr-calculator-api:8080/v1/DownloadResult
      CalculationRunSettings__DownloadCsvBillingApi: http://epr-calculator-api:8080/v1/DownloadBillingFile
      CalculationRunSettings__ClassificationByFinancialYearApi: http://epr-calculator-api:8080/v1/ClassificationByFinancialYear
      CalculationRunSettings__PrepareBillingFileSendToFSS: http://epr-calculator-api:8080/v2/prepareBillingFileSendToFSS
      CalculationRunSettings__CalculationRunApiV2: http://epr-calculator-api:8080/v2/calculatorRuns
      CalculationRunSettings__ProducerBillingInstructionsAcceptApi: http://epr-calculator-api:8080/v1/producerBillingInstructionsAccept
      LapcapSettings__LapcapSettingsApi: http://epr-calculator-api:8080/v1/lapcapData
      BillingFileSettings__BillingFileApi: http://epr-calculator-api:8080/v1/GenerateBillingFile
      ProducerBillingInstructions__ProducerBillingInstructions: http://epr-calculator-api:8080/v1/producerBillingInstructions
      ProducerBillingInstructions__ProducerBillingInstructionsV2: http://epr-calculator-api:8080/v2/producerBillingInstructions
      ParameterSettings__DefaultParameterSettingsApi: http://epr-calculator-api:8080/v1/defaultParameterSetting
      BlobStorage__ConnectionString: DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
    ports:
      - "5294:8080" # taken from launch settings in epr-calculator-frontend
      - "7163:8081" # taken from launch settings in epr-calculator-frontend
    volumes:
      - ./compose/certs/https:/https:ro
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal

  epr-calculator-fss-api:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcalculatorfssapirepository:${EPR_CALCULATOR_FSS_API:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
      azurite:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=PayCal;Integrated Security=True;TrustServerCertificate=True"
      BlobStorage__ConnectionString: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;"
      BlobStorage__ContainerName: "paycal-billingfilejsonauthorisedforfss"
    ports:
      - "6066:8080"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - paycal

  epr-prn-common-backend:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprprncommonbackendrepository:${EPR_PRN_COMMON_BACKEND:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__EprConnectionString: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=EprPrnBackend;TrustServerCertificate=True"
      ConnectionStrings__RunMigration: false
    ports:
      - "5168:8080"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - prn
      - packaging

  epr-prn-common-backend-migrations:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprprncommonbackendrepository:${EPR_PRN_COMMON_BACKEND_MIGRATIONS:-main-latest-database-migrations}
    command: ["/bin/bash", "/home/nonroot/sql/run-migrations.sh", "/home/nonroot/sql/migrations.sql", "/home/nonroot/sql/seed.sql"]
    depends_on:
      sqledge:
        condition: service_healthy
    volumes:
      - ./compose/migrations/run-migrations.sh:/home/nonroot/sql/run-migrations.sh
      - ./compose/epr-prn-common-backend-migrations/seed.sql:/home/nonroot/sql/seed.sql
    environment:
      SERVER: sqledge
      PORT: 1433
      USER: sa
      PASSWORD: "s4usag3s!"
      DATABASE: EprPrnBackend
    profiles:
      - prn
      - packaging

  epr-common-data-api:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcommondataregistry:${EPR_COMMON_DATA_API:-main-latest}
    depends_on:
      sqledge:
        condition: service_healthy
      # token-provider:
      #   condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      # AZURE_SQL_ACCESS_TOKEN_FILE: /tokens/sql.azuresynapse_token.txt
      ConnectionStrings__SynapseDatabase: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=EprCommonData;TrustServerCertificate=True"
    ports:
      - "8002:8080"
    volumes:
      - token-cache:/tokens
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - prn
      - synapse

  epr-common-data-api-migrations:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprcommondataregistry:${EPR_COMMON_DATA_API_MIGRATIONS:-main-latest-database-migrations}
    command: [ "/bin/bash", "/home/nonroot/sql/run-migrations.sh" ]
    depends_on:
      sqledge:
        condition: service_healthy
    volumes:
      - ./compose/epr-common-data-api-migrations/run-migrations.sh:/home/nonroot/sql/run-migrations.sh
      - ./compose/epr-common-data-api-migrations/scripts:/home/nonroot/sql/scripts/compose
    environment:
      SERVER: sqledge
      PORT: 1433
      USER: sa
      PASSWORD: "s4usag3s!"
      DATABASE: EprCommonData
    profiles:
      - prn
      - synapse

  epr-packaging-frontend:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprpackagingfrontendrepository:${EPR_PACKAGING_FRONTEND:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    depends_on:
      redis:
        condition: service_healthy
      epr-facade-account-microservice:
        condition: service_healthy
      epr-payment-facade:
        condition: service_healthy
      epr-pom-api-web:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      Redis__InstanceName: epr-producers-
      Redis__ConnectionString: redis:6379
      AzureADB2C__ClientId: 595f49c3-f886-4869-a1e4-abb0915801ac
      AzureADB2C__ClientSecret: ${EprPackagingFrontend__AzureADB2C__ClientSecret} # see .env
      AzureADB2C__Instance: https://AZDCUSPOC2.b2clogin.com
      AzureADB2C__Tenant: 8a3f509a-c892-4bec-bfe9-d5f5cf251813
      AzureADB2C__Domain: AZDCUSPOC2.onmicrosoft.com
      AzureADB2C__ExtensionsClientId: 0ca9d97c-c219-4623-a2ba-44f326faee16
      UseLocalSession: false
      AccountsFacadeAPI__BaseEndpoint: https://epr-facade-account-microservice:8081/api/
      EprAuthorizationConfig__FacadeBaseUrl: https://epr-facade-account-microservice:8081/api/
      PaymentFacadeApi__BaseUrl: https://epr-payment-facade:8081/api/v1/
      HttpClient__AppServiceUrl: https://epr-pom-api-web:8081
      WebAPI__BaseEndpoint: https://epr-pom-api-web:8081
      # the following are temporary as https://github.com/DEFRA/epr-packaging-frontend/pull/55 includes them
      SubmissionPeriods__6__DataPeriod: "January to June 2026"
      SubmissionPeriods__6__StartMonth: "January"
      SubmissionPeriods__6__EndMonth: "June"
      SubmissionPeriods__6__Year: "2026"
      SubmissionPeriods__6__Deadline: "1 Oct 2026 11:59:00 PM"
      SubmissionPeriods__6__ActiveFrom: "1 Jul 2026 12:00:00 AM"
      SubmissionPeriods__7__DataPeriod: "July to December 2026"
      SubmissionPeriods__7__StartMonth: "July"
      SubmissionPeriods__7__EndMonth: "December"
      SubmissionPeriods__7__Year: "2026"
      SubmissionPeriods__7__Deadline: "1 Apr 2027 11:59:00 PM"
      SubmissionPeriods__7__ActiveFrom: "1 Jan 2027 12:00:00 AM"
    ports:
      - "5145:8080" # taken from launch settings in epr-packaging-frontend
      - "7084:8081" # taken from launch settings in epr-packaging-frontend
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "sh", "-c", "dotnet ${EprPackagingFrontend__Dll}" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "-k", "https://localhost:8081/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-facade-account-microservice:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/facadeaccountcreationrepository:${EPR_FACADE_ACCOUNT_MICROSERVICE:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    depends_on:
      epr-backend-account-microservice:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      AzureADB2C__ClientId: df2b3ff9-b54a-4ddf-8762-bcf07f61a828
      AzureADB2C__ClientSecret: ${EprFacadeAccountMicroservice__AzureADB2C__ClientSecret} # see .env
      AzureADB2C__Instance: https://AZDCUSPOC2.b2clogin.com
      AzureADB2C__Domain: AZDCUSPOC2.onmicrosoft.com
      ApiConfig__AccountServiceBaseUrl: https://epr-backend-account-microservice:8081
      MessagingConfig__ApiKey: ${EprFacadeAccountMicroservice__MessagingConfig__ApiKey} # see .env
      LoggingApi__BaseUrl: http://wiremock
    ports:
      - "5076:8080" # taken from launch settings in epr-facade-account-microservice
      - "7253:8081" # taken from launch settings in epr-facade-account-microservice
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "dotnet", "FacadeAccountCreation.API.dll" ]
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-backend-account-microservice:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/backendaccountserviceregistry:${EPR_BACKEND_ACCOUNT_MICROSERVICE:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    depends_on:
      sqledge:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      ConnectionStrings__AccountsDatabase: "Data Source=sqledge,1433;User id=sa;Password=s4usag3s!;Initial Catalog=EprBackendAccountMicroservice;TrustServerCertificate=True"
      RunMigration: false
    ports:
      - "8003:8080"
      - "8004:8081"
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "dotnet", "BackendAccountService.Api.dll" ]
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-backend-account-microservice-migrations:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/backendaccountserviceregistry:${EPR_BACKEND_ACCOUNT_MICROSERVICE_MIGRATIONS:-main-latest-database-migrations}
    command: [ "/bin/bash", "/home/nonroot/sql/run-migrations.sh", "/home/nonroot/sql/migrations.sql", "/home/nonroot/sql/seed.sql" ]
    depends_on:
      sqledge:
        condition: service_healthy
    volumes:
      - ./compose/migrations/run-migrations.sh:/home/nonroot/sql/run-migrations.sh
      - ./compose/epr-backend-account-microservice-migrations/seed.sql:/home/nonroot/sql/seed.sql
    environment:
      SERVER: sqledge
      PORT: 1433
      USER: sa
      PASSWORD: "s4usag3s!"
      DATABASE: EprBackendAccountMicroservice
    profiles:
      - packaging

  epr-payment-facade:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprpaymentfacaderepository:${EPR_PAYMENT_FACADE:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      AzureADB2C__ClientId: 266861c4-3d0b-4e91-b752-91ca02a4b671
      AzureADB2C__Instance: https://AZDCUSPOC2.b2clogin.com
      AzureADB2C__Domain: AZDCUSPOC2.onmicrosoft.com
      AzureAdB2C__Scopes: https://AZDCUSPOC2.onmicrosoft.com/epr-dev-payments-facade/payment-service
      AzureAdB2C__SignUpSignInPolicyId: B2C_1A_EPR_SignUpSignIn
    ports:
      - "5106:8080" # taken from launch settings in epr-payment-facade
      - "7166:8081" # taken from launch settings in epr-payment-facade
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "dotnet", "EPR.Payment.Facade.dll" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "-k", "https://localhost:8081/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-pom-api-web:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/apiwebrepository:${EPR_POM_API_WEB:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    depends_on:
      redis:
        condition: service_healthy
      epr-prn-common-backend:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      AzureAdB2C__ClientId: 0ff4a0dc-aa85-4b9f-858b-851dbfe7c671
      AzureADB2C__Instance: https://AZDCUSPOC2.b2clogin.com
      AzureADB2C__Domain: AZDCUSPOC2.onmicrosoft.com
      AzureAdB2C__SignUpSignInPolicyId: B2C_1A_EPR_SignUpSignIn
      PrnServiceApi__BaseUrl: http://epr-prn-common-backend:8080
      # PrnServiceApi__ClientId of ce0071ca-d85f-48af-8bfa-025189324054 skipped to avoid DefaultCredentials failure
      Redis__ConnectionString: redis:6379
      AccountApi__BaseUrl: https://epr-backend-account-microservice:8081
      # AccountApi__ClientId of d71ae4ca-49e0-46b9-bc49-71e00deb5005 skipped to avoid DefaultCredentials failure
      LoggingApi__BaseUrl: http://wiremock
      SubmissionStatusApi__BaseUrl: https://epr-pom-api-submission-status:8081
    ports:
      - "5291:8080" # taken from launch settings in epr-pom-api-web
      - "7265:8081" # taken from launch settings in epr-pom-api-web
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "dotnet", "WebApiGateway.Api.dll" ]
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/admin/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-pom-api-submission-status:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/submissionstatusrepository:${EPR_POM_SUBMISSION_STATUS:-main-latest}
    user: "0" # needed to elevate root user so cert can be trusted
    depends_on:
      redis:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8080;https://+:8081
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: password
      ASPNETCORE_ENVIRONMENT: Development
      Logging__LogLevel__Microsoft.AspNetCore: Information
      ConnectionStrings__REDIS_CONNECTION: redis:6379
      LoggingApi__BaseUrl: http://wiremock
      Database__AccountKey: ${EprPomApiSubmissionStatus__Database__AccountKey} # see .env
    ports:
      - "5167:8080" # taken from launch settings in epr-pom-api-web
      - "7206:8081" # taken from launch settings in epr-pom-api-web
    volumes:
      - ./compose/certs/https:/https:ro
      - ./compose/certs/init-container.sh:/init-container.sh:ro
    entrypoint: [ "/init-container.sh" ]
    command: [ "dotnet", "EPR.SubmissionMicroservice.API.dll" ]
    profiles:
      - packaging

  epr-prn-integration-function:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprintegrationfunctionrepository:${EPR_PRN_INTEGRATION_FUNCTION:-main-latest}
    depends_on:
      asb:
        condition: service_healthy
      azurite:
        condition: service_healthy
      wiremock:
        condition: service_started
    volumes:
      - ./compose/azure-functions/host.fake:/azure-functions-host/Secrets/host.json
    environment:
      FeatureManagement__RunIntegration: "true"
      FeatureManagement__RunUpdateProducers: "true"
      FeatureManagement__RunReconciliation: "true"
      IsRunningLocally: "true"
      DefaultLastRunDate: "2024-01-01"
      FUNCTIONS_WORKER_RUNTIME: "dotnet-isolated"
      HOST: "localhost"
      UpdateProducersTrigger: "1,31 0-7 * * *"
      UpdatePrnsTrigger: "0 0 18 * * 1-5"
      FetchNpwdIssuedPrns__Schedule: "0 0 18 * * 1-5"
      EmailNpwdReconciliationTrigger: "0 0 18 * * 1-5"
      ProducersContext: "https://fat.npwd.org.uk/odata/Producers/$$delta"
      PrnsContext: "https://fat.npwd.org.uk/odata/PRNs/$$delta"
      Service__AccountBaseUrl: "http://wiremock"
      Service__AccountClientId: ""
      Service__AccountEndPointName: "api/organisations"
      Service__TimeoutSeconds: "100"
      Service__PrnBaseUrl: "http://wiremock"
      Service__PrnEndPointName: "api/v1/prn"
      Service__PrnEndPointNameV2: "api/v2"
      Service__ClientId: ""
      Service__CommonDataServiceBaseUrl: "http://wiremock"
      Service__CommonDataServiceEndPointName: "api/producer-details"
      ServiceBus__FullyQualifiedNamespace: "asb-backend:5300"
      ServiceBus__FetchPrnQueueName: "defra.epr.npwd.integration.fetchprn.local"
      ServiceBus__ErrorPrnQueue: "defra.epr.npwd.integration.errorqueue.local"
      ServiceBus__FetchPrnDeltaSyncQueueName: "defra.npwd.integration.lastsuccessfulrun.fetchprn.local"
      ServiceBus__UpdateProducerDeltaSyncQueueName: "defra.npwd.integration.lastsuccessfulrun.updateproducer.local"
      ServiceBus__UpdatePrnDeltaSyncQueueName: "defra.npwd.integration.lastsuccessfulrun.updateprn.local"
      ServiceBus__MaxWaitTimeInSeconds: "1"
      ServiceBus__ConnectionString: "Endpoint=sb://asb-backend;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      ServiceBus__TransportType: "AmqpTcp"
      MessagingConfig__Bypass: true
      MessagingConfig__ApiKey: ""
      MessagingConfig__PrnTemplateId: "a43a573c-3367-4aa2-b9ac-6b347ce8bf32"
      MessagingConfig__PERNTemplateId: "24925202-125b-4b85-b54a-9f3100301eb4"
      MessagingConfig__ErrorMessagesTemplateId: "4e67b91b-b010-4d39-a0ea-ecb7e5e77b25"
      MessagingConfig__NpwdEmailTemplateId: "4e67b91b-b010-4d39-a0ea-ecb7e5e77b25"
      MessagingConfig__NpwdEmail: "npwd.support@fake.domain.co.uk"
      MessagingConfig__NpwdValidationErrorsTemplateId: "66bf9f5e-82d3-4f43-8b25-50d6a138a7ef"
      MessagingConfig__NpwdReconcileIssuedPrnsTemplateId: "3f28cb69-4703-46c6-902f-9350aaeebc87"
      MessagingConfig__NpwdReconcileUpdatedOrganisationsTemplateId: "07e89bba-7f0e-47f3-a96d-9fbcd923f9ee"
      MessagingConfig__NpwdCancelledPrnsNotificationTemplateId: "52ec5cdb-ab29-475e-82d5-f5841f016066"
      MessagingConfig__NpwdReconcileUpdatedPrnsTemplateId: "a1b81df4-560e-4034-a3cc-282d00ee2959"
      ApiCallsRetryConfig__WaitTimeBetweenRetryInSecs: "2"
      ApiCallsRetryConfig__MaxAttempts: "3"
      NpwdIntegration__BaseUrl: "http://wiremock"
      NpwdIntegration__ClientId: ""
      NpwdIntegration__ClientSecret: ""
      NpwdIntegration__Scope: ""
      NpwdIntegration__AccessTokenUrl: ""
      NpwdIntegration__Authority: ""
      NpwdIntegration__TimeoutSeconds: "5"
      AppInsightsConfig__ResourceId: ""
      FetchNpwdPrnsPollingLagSeconds: "60"
      UpdatePrnsMaxRows: "100"
      UpdateProducersBatchSize: "100"
      WasteOrganisationsApi__BaseUrl: "http://wiremock"
      WasteOrganisationsApi__ClientId: "dummy-client-id"
      WasteOrganisationsApi__ClientSecret: "dummy-client-secret"
      WasteOrganisationsApi__AccessTokenUrl: "http://wiremock/cognito/oauth/token"
      WasteOrganisationsApi__TimeoutSeconds: "5"
      WasteOrganisationsApi__RetryAttempts: "3"
      WasteOrganisationsApi__RetryDelaySeconds: "1"
      UpdateWasteOrganisations__Trigger: "1,31 0-7 * * *"
      UpdateWasteOrganisations__DefaultStartDate: "2024-01-01"
      FetchRrepwIssuedPrns__Trigger: "0 0 19 * * 1-5"
      FetchRrepwIssuedPrns__DefaultStartDate: "2024-01-01"
      RrepwApi__BaseUrl: "http://wiremock"
      RrepwApi__ClientId: "dummy-client-id"
      RrepwApi__ClientSecret: "dummy-client-secret"
      RrepwApi__AccessTokenUrl: "http://wiremock/cognito/oauth/token"
      RrepwApi__TimeoutSeconds: "5"
      RrepwApi__RetryAttempts: "3"
      RrepwApi__RetryDelaySeconds: "1"
      AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;"
      AzureWebJobsSecretStorageType: "files"
    ports:
      - "7234:80"
    healthcheck:
      test: [ "CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/80' || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - packaging

  epr-prn-obligationcalculations-function:
    pull_policy: always
    image: devrwdinfac1401.azurecr.io/eprobligationcalcrepository:${EPR_PRN_OBLIGATIONCALCULATIONS_FUNCTION:-main-latest}
    depends_on:
      asb:
        condition: service_healthy
      azurite:
        condition: service_healthy
      wiremock:
        condition: service_started
      epr-common-data-api:
        condition: service_healthy
    volumes:
      - ./compose/azure-functions/host.fake:/azure-functions-host/Secrets/host.json
    environment:
      ApplicationConfig__DefaultRunDate: "2025-11-01"
      ApplicationConfig__LogPrefix: "[EPR.PRN.ObligationCalculation]"
      ApplicationConfig__FunctionIsEnabled": true
      AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;"
      AzureWebJobsSecretStorageType: "files"
      FUNCTIONS_WORKER_RUNTIME: "dotnet-isolated"
      PrnServiceApi__BaseUrl: "http://epr-prn-common-backend:8080"
      PrnServiceApi__LogPrefix: "[EPR.PRN.ObligationCalculation]"
      PrnServiceApi__TimeoutFromSeconds: 360
      PrnServiceApi__PrnCalculateEndPoint: "api/v1/prn/organisation/{0}/calculate"
      SubmissionsServiceApi__BaseUrl: "http://epr-common-data-api:8080"
      SubmissionsServiceApi__LogPrefix: "[EPR.PRN.ObligationCalculation]"
      SubmissionsServiceApi__TimeoutFromSeconds: 360
      SubmissionsServiceApi__SubmissionsEndPoint: "api/submissions/v1/pom/approved/"
      StoreApprovedSubmissions__Schedule: "0 0 10 * * *"
      ServiceBus__LogPrefix: "[EPR.PRN.ObligationCalculation]"
      ServiceBus__ObligationLastSuccessfulRunQueueName: defra.epr.obligationlastsuccessfulrun.local
      ServiceBus__ObligationQueueName: defra.epr.obligation.local
      ServiceBus: "Endpoint=sb://asb-backend;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      ServiceBus__ConnectionString: "Endpoint=sb://asb-backend;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
    ports:
      - "7234:80" # need to consider running two functions at the same time
    healthcheck:
      test: [ "CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/80' || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - synapse # this will need to change to obligations

volumes:
  azurite-data:
  sqledge-data:
  token-cache:
